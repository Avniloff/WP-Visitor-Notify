# WP Visitor Notify - Структура проекта и правила разработки

## Продакшен структура файлов

```
wp-visitor-notify/
├── wp-visitor-notify.php               # ✅ Главный файл плагина
├── includes/                           # ✅ Ядро PHP классов
│   ├── class-plugin.php                # ✅ Главный класс (Singleton)
│   ├── class-database.php              # ✅ Операции с БД
│   ├── class-logger.php                # ✅ Система логирования
│   ├── class-uninstaller.php           # ✅ Логика деинсталляции
│   ├── class-tracker.php               # ❌ Отслеживание посетителей
│   ├── class-analytics.php             # ❌ Аналитика данных
│   ├── class-detector.php              # ❌ Определение устройств
│   ├── class-notifier.php              # ❌ Система уведомлений
│   ├── class-cleanup.php               # ❌ Утилиты очистки
│   └── class-validator.php             # ❌ Валидация данных
├── admin/                              # ✅ Админ интерфейс
│   ├── class-admin.php                 # ❌ Главный контроллер
│   ├── class-dashboard.php             # ❌ Dashboard контроллер
│   ├── class-settings.php              # ❌ Settings контроллер
│   ├── class-notifications.php         # ❌ Notifications контроллер
│   ├── class-logs.php                  # ❌ Logs контроллер
│   ├── templates/                      # ✅ HTML шаблоны
│   │   ├── dashboard.php               # ❌ Dashboard панель
│   │   ├── settings.php                # ❌ Страница настроек
│   │   ├── notifications.php           # ❌ Шаблоны уведомлений
│   │   └── logs.php                    # ❌ Просмотр логов
│   └── assets/                         # ✅ CSS и JS
│       ├── css/admin.css               # ❌ Стили админки
│       └── js/admin.js                 # ❌ JS функциональность
├── languages/                          # ✅ Переводы
│   └── wp-visitor-notify.pot           # ❌ Шаблон переводов
└── README.md                           # ✅ Описание проекта
```

## Функции по файлам проекта

### `wp-visitor-notify.php` ✅
- Метаданные плагина (название, версия, автор)
- Проверка версии PHP 8.2+
- Проверка версии WordPress 6.2+
- Собственный автозагрузчик классов (без Composer)
- Константы плагина (WPVN_VERSION, WPVN_PLUGIN_DIR и др.)
- Функция инициализации wpvn_init()
- Обертки хуков: wpvn_activate() -> Plugin::on_activation()
- Обертки хуков: wpvn_deactivate() -> Plugin::on_deactivation()
- Регистрация хука удаления плагина

### `includes/class-plugin.php` ✅
- Singleton pattern (get_instance, __construct, __clone, __wakeup)
- Константы VERSION и PLUGIN_SLUG
- Инициализация компонентов (init_logger, init_database)
- Проверка инициализации (is_initialized)
- Настройка базовых хуков WordPress
- Создание админского меню
- Подключение админских ресурсов
- Регистрация настроек
- Рендер админских страниц (dashboard, settings, notifications, logs)
- Lifecycle методы: on_activation(), on_deactivation() (вызываются из главного файла)
- Получение компонентов (get_component)
- Получение версии плагина

### `includes/class-database.php` ✅
- Инициализация подключения к БД
- Определение имен таблиц с префиксом
- Создание таблиц плагина
- Проверка существования таблиц
- Удаление таблиц
- Получение версии БД
- Получение списка таблиц
- Получение объекта $wpdb

### `includes/class-logger.php` ✅
- Конструктор с настройками уровня логирования
- Основной метод log()
- Методы debug(), info(), error()
- Проверка уровня логирования (should_log)
- Форматирование сообщений (format_message)

### `includes/class-uninstaller.php` ✅
- Главный метод uninstall()
- Удаление настроек плагина (remove_plugin_options)
- ВАЖНО: НЕ удаляет данные посетителей (безопасность!)
- Очистка cron событий (clear_cron_events)
- Удаление capabilities (remove_capabilities)
- Очистка transients (clear_transients)
- Метод drop_database_tables_dangerous() (только для разработки!)

### `includes/class-tracker.php` ❌
- Отслеживание визитов
- Определение IP адреса
- Хеширование IP
- Определение User Agent
- Определение referrer
- Запись данных посетителя
- Создание сессии посетителя
- Подсчет просмотров страниц
- Отслеживание времени на сайте
- Фильтрация ботов
- Исключение админов
- Обработка AJAX запросов

### `includes/class-analytics.php` ❌
- Получение статистики по дням/неделям/месяцам
- Топ страниц по просмотрам
- Статистика по устройствам
- Статистика по браузерам
- Геостатистика
- Почасовая активность
- Статистика referrer
- Расчет bounce rate
- Среднее время на сайте
- Агрегация данных по часам

### `includes/class-detector.php` ❌
- Определение браузера
- Определение операционной системы
- Определение типа устройства (desktop/mobile/tablet)
- Определение версии браузера
- Определение является ли бот
- Получение разрешения экрана
- Определение языка
- Парсинг User Agent

### `includes/class-notifier.php` ❌
- Создание правила уведомления
- Редактирование правила
- Удаление правила
- Проверка условий правил
- Отправка email уведомлений
- Запись истории уведомлений
- Получение списка правил
- Получение истории уведомлений
- Валидация email адресов

### `includes/class-cleanup.php` ❌
- Удаление старых записей (если разрешено)
- Очистка временных файлов
- Оптимизация таблиц БД
- Сжатие старых данных
- Очистка expired transients

### `includes/class-validator.php` ❌
- Валидация IP адресов
- Валидация email адресов
- Санитизация входных данных
- Валидация настроек
- Проверка прав доступа
- Валидация форм

### `admin/class-admin.php` ❌
- Инициализация админского интерфейса
- Подключение стилей и скриптов
- Обработка AJAX запросов
- Общие методы админки
- Проверка прав доступа
- Рендер общих элементов

### `admin/class-dashboard.php` ❌
- Рендер страницы Dashboard
- Получение данных для карточек статистики
- Подготовка данных для графиков
- Формирование таблицы топ страниц
- Формирование таблицы последних посетителей
- Обработка AJAX для обновления данных

### `admin/class-settings.php` ❌
- Рендер страницы настроек
- Регистрация полей настроек
- Валидация настроек
- Сохранение настроек
- Сброс настроек к умолчанию
- Экспорт/импорт настроек

### `admin/class-notifications.php` ❌
- Рендер страницы уведомлений
- Форма создания правила
- Таблица правил уведомлений
- Таблица истории уведомлений
- Редактирование правил
- Тестирование уведомлений

### `admin/class-logs.php` ❌
- Рендер страницы логов
- Фильтрация логов
- Поиск в логах
- Экспорт логов в CSV
- Очистка логов
- Пагинация логов

### `admin/templates/dashboard.php` ❌
- HTML разметка Dashboard
- Карточки статистики
- График активности
- Таблица топ страниц
- Таблица последних посетителей

### `admin/templates/settings.php` ❌
- HTML форма настроек
- Секции настроек
- Поля форм
- Кнопки сохранения

### `admin/templates/notifications.php` ❌
- HTML таблица правил
- HTML форма создания правила
- HTML таблица истории

### `admin/templates/logs.php` ❌
- HTML панель фильтров
- HTML таблица логов
- HTML кнопки управления

### `admin/assets/css/admin.css` ❌
- Стили карточек статистики
- Стили таблиц
- Стили форм
- Стили кнопок
- Адаптивные стили

### `admin/assets/js/admin.js` ❌
- Инициализация Chart.js
- Инициализация DataTables
- AJAX обновление данных
- Обработка форм
- Интерактивность элементов

### `languages/wp-visitor-notify.pot` ❌
- Строки для перевода
- Контекст переводов
- Плюрализация

### Основные файлы

#### `wp-visitor-notify.php` ✅
**Главный файл плагина - точка входа**
- Метаданные плагина (название, версия, автор, требования)
- Проверка версий PHP (8.2+) и WordPress (6.2+)
- Собственный автозагрузчик классов без Composer (namespace WPVN)
- Глобальные константы (WPVN_VERSION, WPVN_PLUGIN_DIR и др.)
- Обертки lifecycle хуков (делегируют работу классам Plugin и Uninstaller)
- Инициализация Plugin singleton через `wpvn_init()`

#### `README.md` ✅
**Описание проекта для GitHub**
- Краткое описание плагина
- Системные требования
- Ключевые особенности
- Структура файлов с отметками статуса (✅/❌)
- Инструкции по установке и разработке

### Папка `includes/` - Ядро классов

#### `class-plugin.php` ✅
**Главный класс плагина (Singleton)**
- Константы: VERSION='1.0.0', PLUGIN_SLUG='wp-visitor-notify'
- Singleton pattern с `get_instance()`, запрет клонирования
- Dependency injection для компонентов (database, logger)
- Базовые хуки WordPress (admin_menu, enqueue_scripts)
- Заглушки админских страниц (dashboard, settings, notifications, logs)
- Lifecycle методы: `on_activation()`, `on_deactivation()` (реальная логика активации/деактивации)

#### `class-database.php` ✅
**Упрощенный класс базы данных**
- Константа DB_VERSION='1.0.0'
- Определение имен таблиц с префиксом WordPress
- Заготовленные схемы таблиц (sessions, page_views, notification_rules и др.)
- Простая проверка `tables_exist()` через опцию `wpvn_db_version`
- Методы `create_tables()` и `drop_tables()` (пока упрощенные)

#### `class-logger.php` ✅
**Система логирования без базы данных**
- Уровни: debug, info, error
- Запись в PHP error_log (видно в Docker)
- Формат: `[timestamp] WPVN.LEVEL[component]: message | Context: {json}`
- Фильтрация по уровню важности
- Методы: `log()`, `debug()`, `info()`, `error()`

#### `class-uninstaller.php` ✅
**Полная очистка при удалении плагина**
- Статический метод `uninstall()` для register_uninstall_hook
- Удаление всех опций плагина
- Удаление всех таблиц БД
- Очистка cron событий (планируется 2 события):
  - `wpvn_hourly_aggregation` - подсчет статистики по часам
  - `wpvn_notification_check` - проверка правил уведомлений каждые 5 минут
- Очистка transients с префиксом wpvn_

### Папка `admin/` - Админ интерфейс

#### `assets/css/admin.css` ❌ (планируется)
**Стили админки**
- Оформление админских страниц

#### `assets/js/admin.js` ❌ (планируется)
**JavaScript админки**
- Интерактивность админки

#### `templates/` ✅ (пустая)
**HTML шаблоны админских страниц**
- Планируется: dashboard.php, settings.php, notifications.php, logs.php

## Содержимое админских страниц

### Dashboard (главная страница)
**Виджеты и таблицы:**
- **Статистика карточки** (4 блока): Сегодня, Эта неделя, Этот месяц - количество посетителей
- **График активности** (Chart.js): Почасовая активность за последние 24 часа
- **Таблица "Топ страниц"** (DataTable): URL, Заголовок, Просмотры
- **Таблица "Последние посетители"** (DataTable): Время, IP, Страница, Устройство, Браузер, Город, Страна
- **Блок уведомлений** (WordPress notices): Важные алерты и системные сообщения

### Settings (настройки)
**Форма настроек WordPress Settings API:**
- **Секция "Отслеживание"**: Checkbox включить/выключить, Select периодичность записи
- **Секция "Приватность"**: Checkbox хешировать IP, Select уровень анонимизации
- **Секция "Уведомления"**: Email field для алертов, Number input частота проверки
- **Секция "Хранение данных"**: Number input дней хранения (только для отображения), Info текст "Данные хранятся постоянно для безопасности"
- **Секция "Исключения"**: Textarea для IP, Checkbox исключить админов/ботов
- **Кнопки**: Save Settings, Reset to Defaults

### Notifications (уведомления)
**Две основные части:**
- **Таблица "Правила уведомлений"** (DataTable): Название правила, Условие, Email, Статус, Действия (Редактировать/Удалить)
- **Форма создания правила**: Select тип события, Number field порог, Email field получатель, Textarea шаблон сообщения
- **Таблица "История уведомлений"** (DataTable): Дата/время, Правило, Получатель, Статус доставки, Сообщение

### Logs (логи)
**Фильтры и таблица:**
- **Панель фильтров**: Select уровень лога, Date picker период, Text input поиск по сообщению
- **Таблица логов** (DataTable): Время, Уровень (цветные badges), Компонент, Сообщение, Контекст (JSON в модальном окне)
- **Кнопки управления**: Clear All Logs, Export CSV, Refresh
- **Pagination**: WordPress стандартная пагинация

### Папка `languages/` ✅ (пустая)
**Файлы переводов**
- Планируется: wp-visitor-notify.pot для интернационализации

## Архитектурные правила проекта

### 1. Собственный автозагрузчик классов
- **БЕЗ Composer** - используем свой автозагрузчик
- Классы именуются: `class-название.php`
- Namespace: `WPVN\ИмяКласса`
- Загрузка: `includes/class-{имя-класса}.php`

### 2. Singleton паттерн для главного класса
- `Plugin::get_instance()` - единственный способ получить экземпляр
- Запрещено клонирование и сериализация
- Инициализация только через `init()` метод

### 3. Система логирования
- **БЕЗ базы данных** - логи идут в `error_log`
- Уровни: `debug`, `info`, `error`
- Формат: `[timestamp] WPVN.LEVEL[component]: message | Context: {json}`
- Видно в Docker логах

### 4. Упрощенная база данных
- Пока создается только версия в опциях
- Схемы таблиц готовы, но не используются
- `Database::tables_exist()` проверяет опцию `wpvn_db_version`

### 5. Требования версий
- **PHP 8.2+** - строгая типизация
- **WordPress 6.2+** - современные функции
- `declare(strict_types=1);` во всех файлах

### 6. Структура админки
- Меню: "Visitor Analytics" с подменю
- Страницы: Dashboard, Settings, Notifications, Logs
- Пока заглушки с базовым HTML
- Capability: `manage_options`

### 7. Lifecycle хуки
- **Активация**: `register_activation_hook() -> wpvn_activate() -> Plugin::on_activation()`
- **Деактивация**: `register_deactivation_hook() -> wpvn_deactivate() -> Plugin::on_deactivation()`
- **Удаление**: `register_uninstall_hook() -> Uninstaller::uninstall()` (удаляет настройки, сохраняет данные)

### 8. Система безопасности
- Проверка `ABSPATH` во всех файлах
- Escape всех выводов
- Capability проверки
- Защита от прямого доступа

### 9. Продакшен окружение
- Только WordPress сайт
- Стандартная установка через админку
- Поддержка хостингов

### 10. Тестирование
- Собственный тест-раннер
- Тесты логгера и других компонентов
- Без PHPUnit - простые assert'ы

## Константы проекта

```php
WPVN_VERSION = '1.0.0'
WPVN_PLUGIN_FILE = __FILE__
WPVN_PLUGIN_DIR = plugin_dir_path(__FILE__)
WPVN_PLUGIN_URL = plugin_dir_url(__FILE__)
WPVN_PLUGIN_BASENAME = plugin_basename(__FILE__)
```

## Git правила

- Исключены файлы разработки (.vscode/, test/, docker-*)
- Логи исключены
- Системные файлы исключены

## Следующие этапы разработки

1. **Создать класс Tracker** - отслеживание посетителей
2. **Создать класс Analytics** - обработка данных
3. **Создать класс Detector** - определение устройств
4. **Создать класс Notifier** - уведомления
5. **Реализовать админские шаблоны**
6. **Добавить CSS/JS ресурсы**
7. **Реализовать полную схему БД**
8. **Добавить переводы**

## Принципы кода

- **Простота** - никаких сложных паттернов без необходимости
- **Читаемость** - обширные комментарии на русском/английском
- **Безопасность** - escape, validate, sanitize
- **Производительность** - ленивая загрузка компонентов
- **Тестируемость** - dependency injection через конструкторы
